#!/bin/bash

echo ""
echo "ğŸ’¡ Welcome! This script will help you connect to an AKS cluster, view Helm app versions, and upgrade IFS Cloud."
echo ""

# Ask for cluster name
read -p "ğŸ‘‰ Please enter the AKS cluster name (example: abcd-dsk-aks): " CLUSTER_NAME

# Switch kube context
echo ""
echo "ğŸ”„ Switching to cluster context: $CLUSTER_NAME ..."
kubectl config use-context "$CLUSTER_NAME"

if [ $? -ne 0 ]; then
  echo "âŒ Failed to switch context to '$CLUSTER_NAME'. Please check the cluster name and try again."
  exit 1
fi

echo "âœ… Successfully connected to '$CLUSTER_NAME'."

# Run helm list
echo ""
echo "ğŸ“‹ Fetching Helm app versions and namespaces in this cluster..."
helm list -A --output json | jq -r '.[] | "\(.app_version) \(.namespace)"'

# Prompt user for version and namespace
echo ""
echo "ğŸ‘‰ Please copy-paste a line from above (format: \"<version> <namespace>\")"
read -p "Enter version and namespace: " IFSVERSION K8S_NAMESPACE

echo ""
echo "âœ… You entered: Version = '$IFSVERSION'  Namespace = '$K8S_NAMESPACE'"
echo ""

# Run Helm upgrade (normal)
echo "ğŸš€ Starting Helm upgrade for IFS Cloud..."
helm upgrade --install ifs-cloud helm/ifs-cloud \
  --version "$IFSVERSION" \
  --namespace "$K8S_NAMESPACE" \
  --debug \
  --values override_values.yml \
  --reuse-values \
  --timeout 15m

if [ $? -ne 0 ]; then
  echo "âŒ Helm upgrade failed. Please review the above output for details."
  exit 1
fi

# Ask if user wants to increase client service memory
echo ""
read -p "âš¡ Do you want to increase the client service memory to 1500 MB? (yes/no): " CONFIRM

if [[ "$CONFIRM" =~ ^[Yy][Ee][Ss]$ || "$CONFIRM" =~ ^[Yy]$ ]]; then
  echo "ğŸš€ Proceeding to increase client service memory..."
  helm upgrade --install ifs-cloud helm/ifs-cloud \
    --version "$IFSVERSION" \
    --namespace "$K8S_NAMESPACE" \
    --set ifsappclientservices.minMemory=1500 \
    --reuse-values \
    --timeout 15m

  if [ $? -eq 0 ]; then
    echo "âœ… Client service memory increased and Helm upgrade completed successfully."
  else
    echo "âŒ Failed to increase client service memory. Please check the logs above."
  fi
else
  echo "â„¹ï¸ Client service memory upgrade was skipped as per your choice."
fi

echo ""
echo "ğŸ‰ Script completed. Thank you!"
